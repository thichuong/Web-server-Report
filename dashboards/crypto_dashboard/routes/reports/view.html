<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard To√†n C·∫£nh Th·ªã Tr∆∞·ªùng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="/shared_assets/css/colors.css">
    <link rel="stylesheet" href="/shared_assets/css/style.css">
    <link rel="stylesheet" href="/shared_assets/css/chart.css">
    <link rel="stylesheet" href="/shared_assets/css/report.css">

    <!-- report-specific CSS inserted from DB -->
    <style>
        /* <![CDATA[ */
        {{ report.css_content }}
        /* ]]> */
        
        /* Auto-loading enhancements */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .card {
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        .positive-change { color: green; }
        .negative-change { color: red; }
        
        .real-time-data {
            position: relative;
        }
        
        .real-time-data::after {
            content: "üî¥";
            position: absolute;
            top: -2px;
            right: -15px;
            font-size: 8px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
    </style>
</head>
<body class="antialiased">
    {% include "crypto/components/theme_toggle.html" %}
    {% include "crypto/components/language_toggle.html" %}

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-extrabold mb-2">
                <span data-i18n="site-title">To√†n C·∫£nh Th·ªã Tr∆∞·ªùng Ti·ªÅn M√£ H√≥a</span>
            </h1>
            <p class="text-lg text-gray-600 max-w-3xl mx-auto">
                <span data-i18n="analysis-summary">B√°o c√°o t·ªïng h·ª£p</span>
            </p>
            <p class="text-base text-gray-500 max-w-3xl mx-auto mt-2">
                <span data-i18n="created-at">t·∫°o l√∫c</span>: <span id="report-created-at" data-created-at="{{ report.created_at }}" class="ml-1 font-medium">{{ report.created_at }}</span>
            </p>
            <div class="mt-6 flex items-center justify-center space-x-4">
                <a href="/" class="inline-block bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700"><span data-i18n="home">Trang ch·ªß</span></a>
                <a href="{{ pdf_url }}" target="_blank" class="inline-block bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-green-700 transition-colors duration-300">
                    <i class="fas fa-print mr-2"></i> <span data-i18n="print-report">In B√°o c√°o</span>
                </a>
                <a href="/crypto_reports_list" class="inline-block bg-gray-700 text-white font-bold py-3 px-6 rounded-lg"><span data-i18n="view-report-history">L·ªãch s·ª≠ b√°o c√°o</span></a>
            </div>
        </header>

        <div class="space-y-6 mb-12">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="card">
                    <div class="flex items-center mb-2">
                        <i class="fab fa-bitcoin text-yellow-500 text-3xl mr-3"></i>
                        <h3 class="text-lg font-semibold text-gray-700" data-i18n="btc-price">Gi√° BTC</h3>
                    </div>
                    <div id="btc-price-container">
                        <div class="skeleton h-9 w-3/4 mb-2"></div>
                        <div class="skeleton h-5 w-1/2"></div>
                    </div>
                </div>
                <div class="card">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-globe-americas text-blue-500 text-3xl mr-3"></i>
                        <h3 class="text-lg font-semibold text-gray-700" data-i18n="market-cap">T·ªïng V·ªën H√≥a</h3>
                    </div>
                    <div id="market-cap-container">
                        <div class="skeleton h-9 w-3/4 mb-2"></div>
                        <div class="skeleton h-5 w-1/2"></div>
                    </div>
                </div>
                <div class="card">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-chart-line text-green-500 text-3xl mr-3"></i>
                        <h3 class="text-lg font-semibold text-gray-700" data-i18n="volume-24h">Kh·ªëi L∆∞·ª£ng Giao D·ªãch 24h</h3>
                    </div>
                     <div id="volume-24h-container">
                        <div class="skeleton h-9 w-3/4 mb-2"></div>
                        <div class="skeleton h-5 w-1/2"></div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="card">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4 text-center" data-i18n="fear-greed-title">Ch·ªâ s·ªë S·ª£ h√£i & Tham lam</h3>
                    <div id="fear-greed-container" class="w-full max-w-sm mx-auto">
                        <div class="skeleton h-48 w-full rounded-full"></div>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4 text-center" data-i18n="rsi-btc-title">Ch·ªâ s·ªë S·ª©c m·∫°nh T∆∞∆°ng ƒë·ªëi (RSI 14) - BTC</h3>
                    <div id="rsi-container" class="w-full max-w-sm mx-auto">
                        <div class="skeleton h-48 w-full rounded-full"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tuy√™n b·ªë mi·ªÖn tr·ª´ tr√°ch nhi·ªám: ch·ªâ mang t√≠nh ch·∫•t tham kh·∫£o (i18n) -->
        <div id="disclaimer" class="mb-6">
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
                <p class="text-sm text-gray-700">
                    <strong data-i18n="disclaimer-title">Tuy√™n b·ªë mi·ªÖn tr·ª´ tr√°ch nhi·ªám:</strong>
                    <span data-i18n="disclaimer-body">N·ªôi dung v√† ph√¢n t√≠ch tr√™n trang n√†y ch·ªâ mang t√≠nh ch·∫•t tham kh·∫£o v√† kh√¥ng c·∫•u th√†nh l·ªùi khuy√™n ƒë·∫ßu t∆∞. M·ªçi quy·∫øt ƒë·ªãnh ƒë·∫ßu t∆∞ l√† tr√°ch nhi·ªám c·ªßa ng∆∞·ªùi ƒë·ªçc.</span>
                </p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-x-12 pb-96">
            <aside class="hidden lg:block lg:col-span-1">
                 <nav id="report-navigation-panel" class="sticky top-8">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3 tracking-wide">M·ª•c l·ª•c B√°o c√°o</h3>
                    <ul id="report-nav-links" class="space-y-2">
                        </ul>
                </nav>
            </aside>
            <main id="report-container" class="lg:col-span-3">
                <!-- Vietnamese report content injected from DB -->
                <div id="report-content-vi">
                    {{ report.html_content }}
                </div>

                <!-- English report content (optional) -->
                <div id="report-content-en" style="display:none;">
                    {{ report.html_content_en }}
                </div>
            </main>
        </div>
    </div>

    <!-- Chart modules will be injected here -->
    <script>
        {{ chart_modules_content }}
    </script>

    <!-- report-specific JS inserted from DB -->
    <script id="report-js">
        {{ report.js_content }}
    </script>

    <script src="/shared_components/core/theme-manager.js" defer></script>
    <script src="/crypto_dashboard/assets/dashboard-websocket.js" defer></script>
    <script src="/crypto_dashboard/assets/translations.js" defer></script>
    <script src="/shared_components/core/language-toggle.js" defer></script>
    <script>
    (function(){
        function formatCreatedAt(){
            const el = document.getElementById('report-created-at');
            if (!el) return;
            const raw = el.getAttribute('data-created-at');
            if (!raw) return;
            // parse as ISO and convert to Asia/Ho_Chi_Minh (+07:00)
            let d = new Date(raw);
            if (isNaN(d.getTime())) {
                // try fallback parse
                d = new Date(Date.parse(raw));
                if (isNaN(d.getTime())) return;
            }

            // Determine language
            const lang = (window.languageManager && window.languageManager.currentLanguage) ? window.languageManager.currentLanguage : document.documentElement.lang || 'vi';

            // Format date in Asia/Ho_Chi_Minh timezone using Intl with timeZone
            try {
                const dateOptions = { year: 'numeric', month: 'short', day: '2-digit', timeZone: 'Asia/Ho_Chi_Minh' };
                const timeOptions = { hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Ho_Chi_Minh', hour12: false };
                const dateFormatter = new Intl.DateTimeFormat((lang === 'en') ? 'en-US' : 'vi-VN', dateOptions);
                const timeFormatter = new Intl.DateTimeFormat((lang === 'en') ? 'en-US' : 'vi-VN', timeOptions);
                const datePart = dateFormatter.format(d);
                const timePart = timeFormatter.format(d);
                el.textContent = datePart + ' | ' + timePart + ' (GMT+7)';
            } catch (e) {
                // fallback simple
                const parts = d.toLocaleString().split(',');
                if (parts.length >= 2) el.textContent = parts[0] + ' | ' + parts.slice(1).join(',');
                else el.textContent = d.toLocaleString();
            }
        }

        // Run on DOM ready (if language-toggle.js already set languageManager this will pick it up)
        document.addEventListener('DOMContentLoaded', function(){
            setTimeout(formatCreatedAt, 50);
        });

        // Update when language changes
        window.addEventListener('languageChanged', function(){
            setTimeout(formatCreatedAt, 50);
        });
    })();
    </script>
</body>
</html>