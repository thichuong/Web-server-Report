<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Toàn Cảnh Thị Trường</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="/shared_assets/css/colors.css">
    <link rel="stylesheet" href="/shared_assets/css/style.css">
    <link rel="stylesheet" href="/shared_assets/css/chart.css">
    <link rel="stylesheet" href="/shared_assets/css/report.css">

    <!-- report-specific CSS inserted from DB -->
    <style>
        /* <![CDATA[ */
        {{ report.css_content }}
        /* ]]> */
        
        /* Auto-loading enhancements */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .card {
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        #refresh-dashboard:hover {
            transform: translateY(-1px);
        }
        
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body class="antialiased">
    {% include "crypto/components/theme_toggle.html" %}
    {% include "crypto/components/language_toggle.html" %}

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-extrabold mb-2">
                <span data-i18n="site-title">Toàn Cảnh Thị Trường Tiền Mã Hóa</span>
            </h1>
            <p class="text-lg text-gray-600 max-w-3xl mx-auto">
                <span data-i18n="analysis-summary">Báo cáo tổng hợp</span>
            </p>
            <p class="text-base text-gray-500 max-w-3xl mx-auto mt-2">
                <span data-i18n="created-at">tạo lúc</span>: <span id="report-created-at" data-created-at="{{ report.created_at }}" class="ml-1 font-medium">{{ report.created_at }}</span>
            </p>
            <div class="mt-6 flex items-center justify-center space-x-4">
                <a href="/" class="inline-block bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700"><span data-i18n="home">Trang chủ</span></a>
                <a href="{{ pdf_url }}" target="_blank" class="inline-block bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-green-700 transition-colors duration-300">
                    <i class="fas fa-print mr-2"></i> <span data-i18n="print-report">In Báo cáo</span>
                </a>
                <a href="/crypto_reports_list" class="inline-block bg-gray-700 text-white font-bold py-3 px-6 rounded-lg"><span data-i18n="view-report-history">Lịch sử báo cáo</span></a>
                <button id="refresh-dashboard" class="inline-block bg-purple-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-purple-700 transition-colors duration-300">
                    <i class="fas fa-sync-alt mr-2"></i> <span data-i18n="refresh-data">Cập nhật dữ liệu</span>
                </button>
            </div>
            
            <!-- Status indicator -->
            <div id="dashboard-status" class="mt-4 text-center">
                <div id="websocket-status" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium">
                    <div class="w-2 h-2 bg-gray-400 rounded-full mr-2 animate-pulse"></div>
                    <span data-i18n="connecting">Đang kết nối...</span>
                </div>
                <div id="last-update" class="mt-2 text-xs text-gray-500">
                    <span data-i18n="last-update">Cập nhật lần cuối</span>: <span id="last-update-time">--</span>
                </div>
            </div>
        </header>

        <div class="space-y-6 mb-12">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="card">
                    <div class="flex items-center mb-2">
                        <i class="fab fa-bitcoin text-yellow-500 text-3xl mr-3"></i>
                        <h3 class="text-lg font-semibold text-gray-700" data-i18n="btc-price">Giá BTC</h3>
                        <div id="btc-refresh-indicator" class="ml-auto opacity-0 transition-opacity duration-300">
                            <i class="fas fa-sync-alt text-green-500 text-sm animate-spin"></i>
                        </div>
                    </div>
                    <div id="btc-price-container">
                        <div class="skeleton h-9 w-3/4 mb-2"></div>
                        <div class="skeleton h-5 w-1/2"></div>
                    </div>
                </div>
                <div class="card">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-globe-americas text-blue-500 text-3xl mr-3"></i>
                        <h3 class="text-lg font-semibold text-gray-700" data-i18n="market-cap">Tổng Vốn Hóa</h3>
                    </div>
                    <div id="market-cap-container">
                        <div class="skeleton h-9 w-3/4 mb-2"></div>
                        <div class="skeleton h-5 w-1/2"></div>
                    </div>
                </div>
                <div class="card">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-chart-line text-green-500 text-3xl mr-3"></i>
                        <h3 class="text-lg font-semibold text-gray-700" data-i18n="volume-24h">Khối Lượng Giao Dịch 24h</h3>
                    </div>
                     <div id="volume-24h-container">
                        <div class="skeleton h-9 w-3/4 mb-2"></div>
                        <div class="skeleton h-5 w-1/2"></div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="card">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4 text-center" data-i18n="fear-greed-title">Chỉ số Sợ hãi & Tham lam</h3>
                    <div id="fear-greed-container" class="w-full max-w-sm mx-auto">
                        <div class="skeleton h-48 w-full rounded-full"></div>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4 text-center" data-i18n="rsi-btc-title">Chỉ số Sức mạnh Tương đối (RSI 14) - BTC</h3>
                    <div id="rsi-container" class="w-full max-w-sm mx-auto">
                        <div class="skeleton h-48 w-full rounded-full"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tuyên bố miễn trừ trách nhiệm: chỉ mang tính chất tham khảo (i18n) -->
        <div id="disclaimer" class="mb-6">
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
                <p class="text-sm text-gray-700">
                    <strong data-i18n="disclaimer-title">Tuyên bố miễn trừ trách nhiệm:</strong>
                    <span data-i18n="disclaimer-body">Nội dung và phân tích trên trang này chỉ mang tính chất tham khảo và không cấu thành lời khuyên đầu tư. Mọi quyết định đầu tư là trách nhiệm của người đọc.</span>
                </p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-x-12 pb-96">
            <aside class="hidden lg:block lg:col-span-1">
                 <nav id="report-navigation-panel" class="sticky top-8">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3 tracking-wide">Mục lục Báo cáo</h3>
                    <ul id="report-nav-links" class="space-y-2">
                        </ul>
                </nav>
            </aside>
            <main id="report-container" class="lg:col-span-3">
                <!-- Vietnamese report content injected from DB -->
                <div id="report-content-vi">
                    {{ report.html_content }}
                </div>

                <!-- English report content (optional) -->
                <div id="report-content-en" style="display:none;">
                    {{ report.html_content_en }}
                </div>
            </main>
        </div>
    </div>

    <!-- Chart modules will be injected here -->
    <script>
        {{ chart_modules_content }}
    </script>

    <!-- report-specific JS inserted from DB -->
    <script id="report-js">
        {{ report.js_content }}
    </script>

    <script src="/shared_components/core/theme-manager.js" defer></script>
    <script src="/crypto_dashboard/assets/dashboard-websocket.js" defer></script>
    <script src="/crypto_dashboard/assets/translations.js" defer></script>
    <script src="/shared_components/core/language-toggle.js" defer></script>
    <script>
    (function(){
        function formatCreatedAt(){
            const el = document.getElementById('report-created-at');
            if (!el) return;
            const raw = el.getAttribute('data-created-at');
            if (!raw) return;
            // parse as ISO and convert to Asia/Ho_Chi_Minh (+07:00)
            let d = new Date(raw);
            if (isNaN(d.getTime())) {
                // try fallback parse
                d = new Date(Date.parse(raw));
                if (isNaN(d.getTime())) return;
            }

            // Determine language
            const lang = (window.languageManager && window.languageManager.currentLanguage) ? window.languageManager.currentLanguage : document.documentElement.lang || 'vi';

            // Format date in Asia/Ho_Chi_Minh timezone using Intl with timeZone
            try {
                const dateOptions = { year: 'numeric', month: 'short', day: '2-digit', timeZone: 'Asia/Ho_Chi_Minh' };
                const timeOptions = { hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Ho_Chi_Minh', hour12: false };
                const dateFormatter = new Intl.DateTimeFormat((lang === 'en') ? 'en-US' : 'vi-VN', dateOptions);
                const timeFormatter = new Intl.DateTimeFormat((lang === 'en') ? 'en-US' : 'vi-VN', timeOptions);
                const datePart = dateFormatter.format(d);
                const timePart = timeFormatter.format(d);
                el.textContent = datePart + ' | ' + timePart + ' (GMT+7)';
            } catch (e) {
                // fallback simple
                const parts = d.toLocaleString().split(',');
                if (parts.length >= 2) el.textContent = parts[0] + ' | ' + parts.slice(1).join(',');
                else el.textContent = d.toLocaleString();
            }
        }

        // Run on DOM ready (if language-toggle.js already set languageManager this will pick it up)
        document.addEventListener('DOMContentLoaded', function(){
            setTimeout(formatCreatedAt, 50);
        });

        // Update when language changes
        window.addEventListener('languageChanged', function(){
            setTimeout(formatCreatedAt, 50);
        });
    })();
    </script>
</body>
</html>